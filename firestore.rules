rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper: is dit een admin?
    function isAdminUser() {
      return request.auth != null && (
        request.auth.token.email == 'bodybalanceapp@gmail.com' ||
        request.auth.token.email == 'marcelvandernet@gmail.com'
      );
    }

    // Standaard: geen toegang
    match /{document=**} {
      allow read, write: if false;
    }

    // Gebruikersdata: alleen eigen data lezen/schrijven
    match /users/{userId} {
      // Admin mag alle gebruikers lezen (voor admin panel)
      allow read: if request.auth != null && (request.auth.uid == userId || isAdminUser());
      allow write: if request.auth != null && request.auth.uid == userId;

      // Subcollecties onder gebruiker
      match /{subcollection}/{docId} {
        // Admin mag profielen lezen + disabled veld schrijven
        allow read: if request.auth != null && (request.auth.uid == userId || isAdminUser());
        allow write: if request.auth != null && (request.auth.uid == userId || isAdminUser());
      }
    }

    // Invite codes
    match /inviteCodes/{code} {
      // Lezen: iedereen (nodig voor validatie bij registratie, voordat user is ingelogd)
      // Codes zijn 8-teken random strings, geen gevoelige data
      allow read: if true;
      // Schrijven: alleen admin (codes aanmaken/beheren)
      allow write: if isAdminUser();
      // Claimen: ingelogde gebruiker mag code markeren als gebruikt
      allow update: if request.auth != null
        && resource.data.usedBy == null
        && request.resource.data.usedBy == request.auth.uid;
    }
  }
}
